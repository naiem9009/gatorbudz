// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with role and tier
model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  company         String?
  phone           String?
  role            Role     @default(PUBLIC)
  tier            Tier     @default(NONE)
  emailVerified   Boolean  @default(false)
  image           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  licenseVerified Boolean  @default(false)
  accountStatus   String   @default("PENDING_REVIEW")

  // Billing (structured)
  billingAddress1   String?
  billingAddress2   String?
  billingCity       String?
  billingState      String?
  billingPostalCode String?
  billingCountry    String?

  // Shipping (structured)
  shippingAddress1   String?
  shippingAddress2   String?
  shippingCity       String?
  shippingState      String?
  shippingPostalCode String?
  shippingCountry    String?

  // Relations
  orderRequests         OrderRequest[]
  invoices              Invoice[]
  userFiles             UserFile[]
  tierProposals         TierChangeProposal[] @relation("proposedBy")
  tierProposalDecisions TierChangeProposal[] @relation("decidedBy")
  auditLogs             AuditLog[]           @relation("actor")
  notes                 UserNote[]
  sessions              Session[]
  accounts              Account[]

  @@index([email])
  @@index([role])
  @@index([tier])
  @@index([accountStatus])
}


model UserFile {
  id          String   @id @default(cuid())
  userId      String
  fileName    String
  filePath    String
  fileType    String
  fileSize    Int
  category    String   // LICENSE, INVOICE, OTHER
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
}

model Session {
  id        String   @id @default(cuid())
  // BA uses expiresAt + token (not expires/sessionToken like NextAuth v4)
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id         String @id @default(cuid())
  accountId  String
  providerId String
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("account")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

// Product model with tier-based pricing and strain-based pricing
model Product {
  id          String        @id @default(cuid())
  productId   String  @unique @default(cuid())
  name        String
  slug        String        @unique
  description String?
  videoUrl    String
  minimumQty  Int          @default(10)
  category    ProductCategory @default(EXOTICS)
  variants     ProductVariant[]
  status      ProductStatus @default(ACTIVE)

  // Product specs
  weight String?           
  potency String?         

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orderItems OrderRequestItem[]

  @@index([category])
  @@index([status])
}


model ProductVariant {
  id            String   @id @default(cuid())
  subcategory   ProductSubcategory
  priceGold     Float?
  pricePlatinum Float?
  priceDiamond  Float?

  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@index([subcategory])
}


enum ProductCategory {
  SUPER_EXOTICS
  PREMIUM_EXOTICS
  EXOTICS
  LIVING_SOIL
  COMMERCIAL_INDOORS
  FRESH_DEPS
  DEPS
}


enum ProductSubcategory {
  GLADES
  CYPRESS
  SEAGLASS
  SANDBAR
}

// Order Request model
model OrderRequest {
  id         String      @id @default(cuid())
  userId     String
  orderId    String     @unique @default("")
  totalPrice Float
  notes      String?
  status     OrderStatus @default(PENDING)

  // Audit trail
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastActorId   String?
  lastActorRole Role?

  // Relations
  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  items   OrderRequestItem[]
  invoice Invoice?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderRequestItem {
  id             String  @id @default(cuid())
  orderRequestId String
  productId      String
  quantity       Int     @default(1)
  unitPrice      Float
  totalPrice     Float
  notes          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt @default(now())

  // Relations
  order   OrderRequest @relation(fields: [orderRequestId], references: [id], onDelete: Cascade)
  product Product      @relation(fields: [productId], references: [id])

  variantId   String?
  strain      String?

  @@index([orderRequestId])
  @@index([productId])
}

// Invoice model
model Invoice {
  id             String        @id @default(cuid())
  userId         String
  orderRequestId String        @unique // One-to-one relationship with order
  invoiceNumber  String        @unique
  total          Float
  status         InvoiceStatus @default(DRAFT)
  issueDate      DateTime      @default(now())
  dueDate        DateTime

  // Payment information
  paymentMethod   PaymentMethod?
  paidAt          DateTime?
  paymentNotes    String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  order       OrderRequest? @relation(fields: [orderRequestId], references: [id], onDelete: Cascade)
  payments    Payment[]

  @@index([userId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([orderRequestId])
  @@map("invoice")
}

model Payment {
  id               String   @id @default(cuid())
  invoiceId        String
  amount           Float
  method           PaymentMethod
  status           String   // PENDING, COMPLETED, FAILED
  reference        String?  // Zelle reference, transaction ID, etc.
  
  
  notes            String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  paidAt    DateTime?

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([reference])
  @@index([createdAt])
  @@map("payment")
}


// Tier change proposal model
model TierChangeProposal {
  id           String         @id @default(cuid())
  userId       String
  proposedTier Tier
  reason       String
  status       ProposalStatus @default(PENDING)

  createdBy    String
  decidedBy    String?
  decidedAt    DateTime?
  decisionNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User @relation("proposedBy", fields: [userId], references: [id], onDelete: Cascade)
  proposer User @relation("decidedBy", fields: [createdBy], references: [id])

  @@index([userId])
  @@index([status])
}

// User notes (CRM-style)
model UserNote {
  id        String @id @default(cuid())
  userId    String
  content   String
  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// Audit log model
model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  actorId   String?
  actor     User?    @relation(fields: [actorId], references: [id], onDelete: SetNull, name: "actor")
  actorRole Role?

  action   String
  entity   String
  entityId String?

  // Extra data
  meta Json?

  @@index([actorId])
  @@index([action])
  @@index([entity, entityId])
}

// Enums
enum Role {
  REJECTED
  PUBLIC
  VERIFIED
  MANAGER
  ADMIN
}

enum Tier {
  NONE
  GOLD
  PLATINUM
  DIAMOND
}

enum OrderStatus {
  PENDING
  APPROVED
  PAID
  READY_TO_SHIP
  SHIPPED
  FULFILLED
  REJECTED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  MANUAL
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ProposalStatus {
  PENDING
  APPROVED
  REJECTED
}


model Notification {
  id          String   @id @default(cuid())
  notify_user String
  notify_receiver String
  notification_data String
}
